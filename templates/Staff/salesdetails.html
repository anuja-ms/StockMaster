{% load static %}
{% include 'Staff/header.html' %}

<div class="container mt-4">
    <div class="card shadow-lg p-4 rounded border-0 bg-light">
        <h3 class="text-center text-dark fw-bold">Sales Details</h3>
        <form action="{% url 'salesdetails_process' %}" method="post">
            {% csrf_token %}
            <div class="row g-3 align-items-center">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Subcategory</label>
                    <select class="form-select border-primary" name="subcategoryid" id="subcategory" required>
                        <option value="">Select Subcategory</option>
                        {% for sc in subcategory %}
                            <option value="{{ sc.subcategoryid }}">{{ sc.subcategoryname }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Brand</label>
                    <select name="brandid" id="brand" class="form-select border-primary" required>
                        <option value="">Select Brand</option>
                        {% for b in brands %}
                            <option value="{{b.brandid}}">{{b.brandname}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Product</label>
                    <select name="productid" id="products" class="form-select border-primary" required>
                        <option value="">Select Product</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Price</label>
                    <input type="text" id="productPrice" name="productPrice" class="form-control border-primary" placeholder="Product Price" readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Quantity</label>
                    <input type="number" id="quantity" name="quantity" class="form-control border-primary" placeholder="Quantity" onchange="calculate()" min="1" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Total Amount</label>
                    <input type="text" id="productamount" class="form-control border-primary" name="productamount" placeholder="Total Amount" readonly>
                </div>
                <div class="col-md-3 mt-4">
                    <button id="addMore" class="btn btn-primary w-100 shadow-sm">Add More</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="container mt-5">
    <div class="card shadow-lg p-4 rounded border-0 bg-light">
        <form action="{% url 'salesmaster_process' %}" method="post">
            {% csrf_token %}
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Bill No</label>
                    <input type="text" id="billno" name="billno" class="form-control border-primary" placeholder="Enter Bill No" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Date</label>
                    <input type="date" id="date" name="salesdate" class="form-control border-primary" required>
                </div>
            </div>

            <div class="table-responsive mt-4">
                <table class="table table-hover table-bordered text-center rounded shadow-sm">
                    <thead class="table-dark text-white">
                        <tr>
                            <th>Sl No</th>
                            <th>Product Name</th>
                            <th>Product Image</th>
                            <th>Product Amount</th>
                            <th>Quantity</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in sales %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ s.productid.productname }}</td>
                            <td><img src="/Images/{{ s.productid.image }}" alt="Product Image" class="img-thumbnail" style="width: 60px;"></td>
                            <td>{{ s.productamount }}</td>
                            <td>{{ s.quantity }}</td>
                            <td>
                                <a href="{% url 'deletesalesdetails' salesdetailsid=s.salesdetailsid %}" class="btn btn-danger btn-sm shadow-sm" onclick="return confirm('Do you want to Delete?')">Delete</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-end fw-bold">Grand Total:</td>
                            <td colspan="2">
                                <input type="number" id="grandTotal" name="grandTotal" class="form-control border-primary" readonly />
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="d-flex justify-content-center mt-4">
                <input type="submit" class="btn btn-success w-50 shadow-sm" value="Submit" />
            </div>
        </form>
    </div>
</div>


<script src="{% static 'Admin/jquery-3.7.1.min.js' %}"></script>
<script>
  $(document).ready(function() {
    $.ajaxSetup({
      headers: { "X-CSRFToken": '{{csrf_token}}' }
    });

    // Populate products based on brand and subcategory
    $('#brand').change(function () {
      var brandid = $(this).val();
      var subcategoryid = $("#subcategory").val();
      if (subcategoryid == "") {
        alert("Choose the subcategory also");
      } else {
        $.ajax({
          type: "POST",
          url: '{% url "fillproductss" %}',
          data: { sid: subcategoryid, bid: brandid },
          dataType: "json",
          success: function (data) {
            $('#products').empty();
            var option = '<option value="" >Select Product</option>';
              $('#products').append(option);
            $.each(data, function (key, val) {
              // Append each product with the price stored in data-price
              var option = '<option value="'+val.productid+'" data-price="'+val.price+'" data-stock="' + val.stock + '">'+val.productname+'</option>';
              $('#products').append(option);
            });
          }
        });
      }
    });

    // When product is selected, display price
    $('#products').on('change', function() {
      var selectedOption = $(this).find('option:selected');
      var price = selectedOption.data('price'); // Get the price from the data-price attribute

      if (price) {
        $('#productPrice').val(price); // Display the price in the price input field
        calculate(); // Recalculate the total amount based on the price
      } else {
        console.log("Price not found for this product.");
      }
    });

    // When quantity is entered, calculate the total amount
    $('#quantity').on('input', function() {
      calculate();
    });
  });

  // Function to calculate total amount
  function calculate() {
    var qty = document.getElementById('quantity').value;
    var price = document.getElementById('productPrice').value;

    if (qty && price) {
      var total = parseInt(qty) * parseInt(price);
      document.getElementById('productamount').value = total;
    } else {
      document.getElementById('productamount').value = 0;
    }
  }

  // Function to calculate grand total and update the input field
  function calculateGrandTotal() {
    var grandTotal = 0;

    // Loop through each row and add up the product amounts
    $('tbody tr').each(function() {
      var amount = parseFloat($(this).find('td:nth-child(4)').text()) || 0;
      grandTotal += amount;
    });

    // Display the grand total in the input field
    $('#grandTotal').val(grandTotal.toFixed(2));
  }

  // Call the function on page load
  $(document).ready(function () {
    calculateGrandTotal();
  });

  // Recalculate the grand total whenever a new item is added
  $('#submit').on('click', function() {
    setTimeout(calculateGrandTotal, 500); // Delay to ensure new row is added
  });
</script>

<script>
  $(document).ready(function() {
    // Set today's date in the date input
    var today = new Date().toISOString().split('T')[0];
    $('#date').val(today);
  });
</script>